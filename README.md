# Molecular dynamics simulation of protein-ligand interactions

## What are Molecular Dynamics (MD) simulations? 

Molecular dynamics (MD) simulations are capable of predicting how every atom in a protein or a system will move over time. Such simulations can showcase a variety of biomolecular processes, such as conformational changes, ligand binding and protein folding. 

MD simulations can be divided into two major groups: All-atom and coarse-grained.

All-atom simulations represent every atom present in the system, making them extremely precise if computational heavy. Coarse-grained simulations, on the other hand, split atoms into beads. Each bead is usually equivalent to four non-hydrogen atoms. Because the atoms are grouped inside of beads and not individually being processed, coarse-grained simulations are faster and less computationally heavy at the cost of a slight loss in precision.

![20250623_101553-COLLAGE](https://github.com/user-attachments/assets/8af1b0ce-3234-496b-9a07-afad9679b6b2)
 _Figure 1. On the left, an atomistic representation of T4 lysozyme. On the right, a coarse-grained representation of the same protein._




## Tools
In this workshop, we will be working with a couple of different tools.

- The coarse-graining of the structure was done using [Martini3](https://cgmartini.nl/)

- For subsequent stages of the MD simulation, we will be using [GROMACS](https://www.gromacs.org/)
  
- For visualization, we will be using [PyMOL](https://pymol.org/)

## GROMACS terminology

- `.top`: This is your topology file. It contains important information about all the atoms present in the structure and how they bond to each other through chemical bonds.

- `.gro`: This is a file where the spatial coordinates of your atoms will be stored during your molecular dynamics simulation. It is a unique file, GROMACS exclusive. It can be read on your favourite visualization tool, such as Pymol or VMD, in the same way as a PDB file.

- `.xtc`: This is your trajectory file. It’s where all the trajectory information from your molecular dynamics will be stored.

- `.tpr`: This file contains both your topology and your coordinates information.

- `.itp`: It stands for Include Topology. This file contains the topology information, which can be bond lengths, bond angles, dihedral angles and force constants, for a specific molecule or group of molecules. Your protein will have its own itp file. This file should be included in the main topology file (e.g your system.top file) using #include. Martini also provides you with some pre-made itp files, such as one for small molecules, solvents and ions. If you wish, or if there’s ever the need for, you could create your own itp files too.

- `.mdp`: This is the file that will set up the parameters for each step of your molecular dynamics run. Each step should have a different mdp file as each step has different parameters; some may need positional restraints while others may have their results affected by that.
  
- `-v`: The verbose flag is used to give some feedback on your run. It is good to diagnose errors that might happen in your run.

- `-ss`: Coarse grained structures such as the ones generated by Martini are known for the loss of directional H bonds. This is an inherent consequence of coarse graining. The loss of those directional H bonds means that a coarse-grained structure is more likely than all atoms to have its tertiary structures destabilized. One way to mitigate this is to insert a structure bias model. In the case of our simulations, we are using an elastic network structure bias model.

-  `-p`: This flag will tell GROMACS to upload your topology file after running the current step.

- `-cp`: The configuration of the protein. It is used to specify the solute. This is the output of previous gmx editconf steps.

- `-cs`: The configuration of the solvent. It is used to specify the solvent. This is part of the standard GROMACS installation.

- `-radius`: Used to define the van der Waals distance.

- `-o`: This is your output file. It contains data that was generated during the steps of your simulation.
- `-f`: This flag will show GROMACS where to find your input file.

# General Workflow
This workflow is based on the fantastic job done by the [Martini Force Field Initiative team](https://cgmartini.nl/docs/tutorials/Martini3/Protein_Ligand_Binding/). This workshop will take you through an abridged version of that tutorial, guiding you through the necessary steps to set up a coarse-grained protein-ligand simulation.

### Loading the necessary modules
Your first step is to load the GROMACS module. To do so, just type: 
```
module load GROMACS
```
### Download the repository
This will make sure that you have all the files necessary to run our simulation, including the already worked outputs.

First, we're going to set up a directory where we will be running our simulation off. The `mkdir` command creates a new directory with a name chosen by us. In this case, we will be using our own name as a directory name. Make sure to change the your-name part of the command to your actual name.

```
mkdir your-name
```
Then we're gonna move inside of the directory. Think as this as if moving inside folders in your computer. To move inside that directory, we're going to use the cd command.
```
cd your-name
```
Now that we're inside the directory, we should download the repository. 

```
git clone https://github.com/nicoleyshebbel/Molecular-Dynamics-workshop
cd Molecular-Dynamics-workshop/'Simulation Files'
```

### Introduction

In this workshop, we will set up a coarse-grained molecular dynamics simulation of protein-ligand interactions using Martini3 and GROMACS. We will simulate the binding of benzene to the soluble globular protein T4 lysozyme(PDB: [181L](https://www.rcsb.org/structure/181L)). In this workshop, for the sake of time, we will be running an abridged molecular dynamics simulation, focusing on running the simulation starting from the solvation step.

Prior to solvation, there are some steps that should be taken to guarantee a properly equilibrated system such as generating the topology and coarse-grained structure, defining the simulation box and a minimization run in vacuum. The preparation section goes over these steps, describing them and what outputs they produce. You are not expected to run any of these previous steps, instead you are supposed to start following the tutorial from the Running the Simulation section onwards.

## Preparation 

### Topology and coarse-grained structure
Coarse grained structures such as the ones generated by Martini are known for the loss of directional H bonds. This is an inherent consequence of coarse graining. The loss of those directional H bonds means that a coarse-grained structure is more likely to have its tertiary structures destabilized. One way to mitigate this is to insert a structure bias model. In the case of our simulations, we are using an elastic network structure bias model.

This step will generate 3 different files: A coarse-grained structure, a system topology file and protein topology file.  

![test2](https://github.com/user-attachments/assets/ddbde26d-5448-467e-a25e-81ed3a804760)
_Figure 2. The coarse-grained structure of T4 lysozyme_

### Simulation box
After the topology and coarse-grained structure of the protein were generated, the next step is to make a simulation box that can comfortambly accommodate your protein.

It is important to make sure that your protein has enough room inside the box to avoid close contacts between periodic images of the protein. Typically, a minimum distance of 1.0 nm from the protein to any box edge tends to be used. If there are still close contacts, it might be recommend to have a larger box (e.g allowing for a distance of 1.5 nm from the protein to any box edge).

### Energy minimization
 
Once the protein has been placed inside the simulation box, it's important to run a short minimization run. This step ensures that there are no steric clashes or inappropriate geometry in our system.  `gmx grompp` will assemble the structure, topology and simulation parameters into a binary input file (.tpr). This file file will be used in a later step to run the energy minimization. This step will generate a file containing the spatial coordinates of your system (.gro). This file called minimization-vac.gro will be used for subsequent steps in this workshop.

![test2](https://github.com/user-attachments/assets/894727a4-7d7d-4e7d-a17d-dad83f3313d3)
_Figure 3. The coarse-grained structure of T4 lysozyme after a minimization in vacuum._

## Running the simulation

Now, we will actually start to run our simulation using the files that are inside the 'Simulation Files' directory. 

### Solvating the system

It's time to fill the simulation box with water. Here we will use the -cp flag to tell GROMACS that our solute informations can be found inside the minimization-vac.gro file. The -cs flag will tell GROMACS that we want to use `water.gro` as our solvent. The -p flag refers to our topology file (system.top), instructing GROMACS to update the topology file after the solvation step.

```
gmx solvate -cp minimization-vac.gro -cs water.gro -radius 0.21 -o solvated.gro -p system.top
```
![image](https://github.com/user-attachments/assets/86404276-c2c3-4640-9f44-8888426e302e)

_Figure 4. The system after solvation._


### Adding Ions

After the system has been solvated, it's time to add counter neutralizing ions. Since our protein is charged, it's important to add those ions in order to neutralize our protein's charge. Also, in order to get as close as possible to physiological conditions, it's advisable to use a NaCl concentration of 0.15M.

Usually, a mdp file is supposed to have information regarding the run, but since in this case the mdp file will only be used to generate a tpr file, it's fine to use an empty file. 
```
touch ions.mdp
```
Once we generated the (empty) mdp file, it's time to generate the .tpr file
```
gmx grompp -f ions.mdp -c solvated.gro -p system.top -o ions.tpr
```
Now that we have the ions.tpr file, it's time to add the ions to our system.

```
gmx genion -s ions.tpr -o solvated.gro -p system.top -pname NA -nname CL -neutral -conc 0.15
```

When prompted, you should select Group 13 (W).  You wouldn't want to add ions to your protein structure, would you? 

This is what your command line should look like once you hit enter:

```
Command line:
  gmx genion -s ions.tpr -o solvated.gro -p system.top -pname NA -nname CL -neutral -conc 0.15

Reading file ions.tpr, VERSION 2024.4-plumed_2.9.2 (single precision)
Reading file ions.tpr, VERSION 2024.4-plumed_2.9.2 (single precision)
Will try to add 39 NA ions and 47 CL ions.
Select a continuous group of solvent molecules
Group     0 (         System) has  3340 elements
Group     1 (        Protein) has   381 elements
Group     2 (      Protein-H) has   381 elements
Group     3 (        C-alpha) has     0 elements
Group     4 (       Backbone) has     0 elements
Group     5 (      MainChain) has     0 elements
Group     6 (   MainChain+Cb) has     0 elements
Group     7 (    MainChain+H) has     0 elements
Group     8 (      SideChain) has   381 elements
Group     9 (    SideChain-H) has   381 elements
Group    10 (    Prot-Masses) has   381 elements
Group    11 (    non-Protein) has  2959 elements
Group    12 (          Other) has  2959 elements
Group    13 (              W) has  2959 elements
Select a group:
Selected 13: 'W'
```


![image](https://github.com/user-attachments/assets/e56b5bfd-2f12-4bfe-ad29-0352a624fb59)
_Figure 5. The system after solvation and the addition of ions._


#### Adding the ligand to the simulation cell

After the system has been solvated, it's time to add the ligand into the simulation cell. In order to do so, first we should make a copy of our `solvated.gro` file
```
cp solvated.gro protein_ligand.gro
```
Once that's done, it's time to add the ligand coordinates inside of your protein_ligand.gro file: 

```
bash add_ligand.sh
````

Don't forget to update the number of atoms in your file!
```
awk 'NR==2 {$1=$1+3} {print}' protein_ligand.gro > tmp && mv tmp protein_ligand.gro
```

![image](https://github.com/user-attachments/assets/e31e8e85-ab98-4376-96cd-67eebcae0165)

_Figure 6. Protein and ligand inside the solvated simulation cell. In green, T4 lysozyme. In orange, benzene, which is our ligand._



#### Updating the topology file

After having our system undergo so many changes, it is important to update your topology file. Run this command to do so:
```
bash update_topology.sh

```

### Second energy minimization

After adding ions and solvating our system, it's important to run a second minimization run. This second minimization run should also be longer than our first one, owing up to the fact that we now have a more complex system that will require more steps before reaching the lowest energy setting.

```
gmx grompp -p system.top -c protein_ligand.gro -f minimization.mdp -o minimization.tpr -r protein_ligand.gro
```
```
gmx mdrun -deffnm minimization -v
```

### Equilibration run -Temperature

This first equilibration run is going to be a so-called NVT ensemble or a canonical ensemble. In this type of ensemble, the amount of substance/number of particles (N), volume(V) and temperature are conserved.This step is crucial to get our system to the temperature in which we want to run our simulation. Usually, the thermostat is set to 300K. Although less common, it can be set to 298K in some cases.

```
gmx grompp -p system.top -c minimization.gro -f nvt_eq.mdp -o nvt.tpr -r protein_ligand.gro
```
```
gmx mdrun -deffnm nvt -v
```

### Equilibration run- Pressure

Once the temperature of the system is stabilized, it's time to move on to stabilization of the pressure and density of our system. This step is conducted under an NPT ensemble, which means that the substance/number of particles (N), pressure (P) and temperature (P) are conserved. This ensemble can also be called isothermal-isobaric ensemble. It closely resembles experimental conditions.

```
gmx grompp -f npt_eq.mdp -c nvt.gro -r nvt.gro -p system.top -o npt.tpr
```
```
gmx mdrun -deffnm npt -v
```
### Production run

After our two rounds of equilibration, our system is now well equilibrated and ready to enter the production run. It is recommended to run this step using sbatch, as it takes considerably longer than the previous steps.

```
gmx grompp -p system.top -c npt.gro -f dynamic.mdp -o dynamic.tpr -maxwarn 1
```
After running `.gmx grompp.` you should run the next step using the provided sbatch script. To do so, just copy the following command:
```
sbatch md.sbatch
```
It should take around 30 minutes for this last step. There will be a output file provided in case your simulation takes longer to run or you weren't able to reach this step.
By the end of this run, you should have three different files: Two trajectory files (.xtc and .tpr) and a file containing the spatial coordinates of your atoms during your molecular dynamics simulation (.gro)

### Analysis

Now that we have the data generated during our production run, it's time to analyse it. First, we should post-process our trajectory output using gmx trjconv.

This first step removes the jumps that might be caused by periodic boundaries artifacts. When prompted, you should select System (Group 0) as your input.

```
gmx trjconv -s dynamic.tpr -f dynamic.xtc -o traj_nojump.xtc -pbc nojump
```
The second step is here to correct any molecule that may have been "broken" across Periodic Boundary Conditions (PBC). When prompted, you should select System (Group 0)

```
gmx trjconv -s dynamic.tpr -f traj_nojump.xtc -o traj_whole.xtc -pbc whole
```
And finally, the third step makes sure that your protein is centered inside of your simulation box. When prompted, you should select first Protein (Group 1) and then System (Group 0)
```
gmx trjconv -s dynamic.tpr -f traj_whole.xtc -o traj_centered.xtc -center -pbc mol -ur compact
```

### Preparing the system for visualization

Martini3 uses different naming conventions than VMD or Pymol, making these two visualizers unable to properly showcase your protein. Because of the incompatibilities between naming conventions, your system will show up as if just made of solvent and ions.

In order to fix this, first you must generate a pdb file based on your production run.

```
gmx trjconv -f dynamic.xtc -s dynamic.tpr -fit rot+trans -o simulation.pdb -conect
```

Then you should run the renaming.py script to translate the pdb file into a compatible Pymol pdb.

```
python rename.py simulation.pdb simulation_system.pdb
```
Now Pymol should be able to easily read your file.

### Visualization

Open your file in PyMOL. Load your trajectory using the following command: 
```
load_traj traj_centered.xtc, simulation_system, start=0, stop=1000
```
![image](https://github.com/user-attachments/assets/0cd05d6b-88ad-4b1c-8e7a-980cdb1daa00)
_Figure 7. And there you have it! You have run a molecular dynamics simulation of protein-ligand interactions_

