# Molecular Dynamics workshop

## What are Molecular Dynamics (MD) simulations? 

Molecular dynamics (MD) simulations are capable of predicting how every atom in a protein or a system will move over time. Such simulations can showcase a variety of biomolecular processes, such as conformational changes, ligand biding and protein folding. 

MD simulations can be divided into two major groups: All-atoms and coarse-grained.

All-atoms simulations represent every atom present in the system, making them extremely precise if computational heavy. Coarse-grained simulations, on the other hand, split atoms into beads. Each bead is usually equivalent to four non-hydrogen atoms. Because the atoms are grouped inside of beads and not individually being processed, coarse-grained simulations are faster and less computationally heavy at the cost of a slight loss in precision.
![20250623_101553-COLLAGE](https://github.com/user-attachments/assets/8af1b0ce-3234-496b-9a07-afad9679b6b2)
 _Figure 1. On the left, an atomistic representation of T4 lysozyme. On the right, a coarse-grained representation of the same protein._




## Tools
In this workshop, we will be working with a couple of different tools.

- For coarse-graining our structure and topology, we will be using [Martini3](https://cgmartini.nl/)

- For subsequent stages of the MD simulation, we will be using [GROMACS](https://www.gromacs.org/)
  
- For visualization, we will be using [PyMOL](https://pymol.org/)

## GROMACS terminology

- `.top`: This is your topology file. It contains important information about all the atoms present in the structure and how they bond to each other through chemical bonds.

- `.gro`: This is a file where the spatial coordinates of your atoms will be stored during your molecular dynamics simulation. It is a unique file for GROMACS. It can be read on your favourite visualization tool, such as Pymol or VMD, in the same way as a PDB file.

- `-v`: The verbose flag is used to give some feedback on your run. It is good to diagnose errors that might happen in your run.

- `-p`: This flag will tell martinize2 where to put your restraints. In the case of molecular dynamics containing proteins, unless you have a very specific objective, you should put the restraints onto the backbone of your protein.
- `.xtc`: This is your trajectory file. It’s where all the trajectory information from your molecular dynamics will be stored.

- `.tpr`: This file contains both your topology and your coordinates information.

- `.itp`: It stands for Include Topology. This file contains the topology information, which can be bond lengths, bond angles, dihedral angles and force constants, for a specific molecule or group of molecules. Your protein will have its own itp file. This file should be include in the main topology file (e.g your system.top file) using #include. Martini also provides you with some pre-made itp files, such as one for small molecules, solvents and ions. If you wish, or if there’s ever the need for, you could create your own itp files too.

- `.mdp`: This is the file that will set up the parameters for each step of your molecular dynamics run. Each step should have a different mdp file as each step has different parameters; some may need positional restraints while others may have their results affected by that.

- `-ss`: Coarse grained structures such as the ones generated by Martini are known for the loss of directional H bonds. This is an inherent consequence of coarse graining. The loss of those directional H bonds mean that a coarse-grained structure is more likely than all atoms to have its tertiary structures destabilized. One way to mitigate this is to insert a structure bias model. In the case of our simulations, we are using a elastic network structure bias model.

- `-cp`: The configuration of the protein. This is the output of previous gmx editconf steps.

- `-cs`: The configuration of the solvent. This is part of the standard GROMACS installation.

# General Workflow
This workflow is based on the fantastic job done by the [Martini Force Field Initiative team](https://cgmartini.nl/docs/tutorials/Martini3/Protein_Ligand_Binding/). This workflow will take you through the necessary steps to set up a coarse-grained protein-ligand simulation.

### Loading the necessary modules
Your first step is to load the GROMACS module. To do so, just type: 
```
module load GROMACS
```
If you don't have Martini3 installed yet, now is the time to install it. You should create an environment for it: 
```
conda create -n martini python=3.9
```
```
conda activate martini
```
```
pip install vermouth
```

### Obtaining the input for the simulation
You can manually download your protein(s) of interest directly from your favourite database, e.g The Protein Data Bank. You could also use a command to download it directly into your directory.
```
wget http://www.rcsb.org/pdb/files/181L.pdb
```
### Cleaning the input structure
```
grep "^ATOM" 181L.pdb > 181L_clean.pdb
```
This step is done in order to avoid that your protein file contains anything but your actual protein. Be careful, this step will remove anything that is not part of your protein including ligands. After you clean your structure, open the your_protein_clean.pdb file in your favourite visualizer to make sure it contains only the protein.
![20250623_103821-COLLAGE](https://github.com/user-attachments/assets/8239ceac-a439-4e88-a74f-0517a0cefa8c)
 _Figure 2. On the left, 181L structure before cleaning. On the right, the clean 181L structure._


### Specifying the secondary structure

The spherical potentials used during coarse-graining leads to the loss of directional bonds, which in turn can impact the stability of secondary, tertiary and quartenary structure of proteins. Because of that, coarse-grained models require a structure bias model to stabilize protein structures. In this workshop, we will be using the Elastic Network structure bias model to stabilize our structure.

But for that we need to specify the secondary structure of our protein. We can do that on PyMol quite easily. 

After loading your PDB file on Pymol, you can load these commands to get the assign the secondary structure to your protein and also get a ss file with those informations.

```
stored.ss = []
iterate (name CA), stored.ss.append(ss)
```
```
ss_martini = "".join(['H' if x == 'H' else 'E' if x == 'S' else 'C' for x in stored.ss])
```
```
f = open("ss_output.txt", "w")
f.write(ss_martini)
f.close()
```
You will find your file inside the File > Working Directory > File Browser. This will open the folder where your text output was place. It is the same Working Directory as the one where your PDB file came from.

### Generating topology and coarse-grained structure
```
martinize2 -f 181L_clean.pdb -o system.top -x 181L_clean.pdb -p backbone -ff martini3001 -elastic -ef 700.0 -el 0.5 -eu 0.9 -ea 0 -ep 0 -ss CCHHHHHHHHHCCCCCCEEECCEEEECCCCCCCCCCCCHHHHHHHHHHHHCCCCCCCCCHHHHHHHHHHHHHHHHHHHHHCCCHHHHHHHCCHHHHHHHHHHHHHHCHHHHHHCHHHHHHHHHCCHHHHHHHHHCCHHHHHCHHHHHHHHHHHHHCCCHHHC
```
martinize2 will generate 3 different files: A coarse-grained structure (cg_protein.pdb), a topology file ( system.top) and protein topology file ( molecule_0.itp). The amount of protein topology files will be entirely depedent on the amount of proteins in your system. Now, we should make a box that will accomodate our protein.
![test2](https://github.com/user-attachments/assets/ddbde26d-5448-467e-a25e-81ed3a804760)
_Figure 3. The coarse-grained structure of T4 lysozyme_



### Defining the simulation box
Now it's time to place the protein inside a simulation box.

```
gmx editconf -f 181L_clean.pdb -o 181L_clean.gro -d 1.0 -bt cubic -c
```
You want to make sure that your protein has enough room inside the box to avoid close contacts between periodic images of the protein. Typically, a minimum distance of 1.0 nm from the protein to any box edge tends to be used. If you still encounter close contacts, it might be recommend to make your box larger (e.g allowing for a distance of 1.5 nm from the protein to any box edge)

#### Checking the topology

You will need to add some more lines into your system.top file. The order of these files is extremely important, so you should be mindful where you put them. It is important that martini.itp, the file that gives the parameters for the Martini force field, be the first file. After that, it should come your molecule(s) topology file. And after the topology, then you can add other files(e.g martini_v3.0.0_small_molecules_v1.itp, martini_v3.0.0_solvents_v1.itp, etc). By now, your topology file for your system should look something like this:
```
#include "martini.itp"
#include "molecule_0.itp"
#include "martini_v3.0.0_small_molecules_v1.itp"
#include "martini_v3.0.0_ions_v1.itp"
#include "martini_v3.0.0_solvents_v1.itp"

[ system ]
Title of the system in water

[ molecules ]
molecule_0    1
```

### Energy minimization
 
Once the protein has been placed inside the simulation box, it's time to run a short minimization run. This step ensures that there are no steric clashes or inappropriate geometry in our system.  

gmx grompp will assemble the structure, topology and simulation parameters into a binary input file (.tpr). This file file will be used in a later step to run the energy minimization.

```
gmx grompp -p system.top -f minimization.mdp -c 181L_clean.gro -o minimization-vac.tpr  -r 181L_clean.gro
```
Now that we have our .tpr file, we can run the energy minimization
```
gmx mdrun -deffnm minimization-vac -v
```
![test2](https://github.com/user-attachments/assets/894727a4-7d7d-4e7d-a17d-dad83f3313d3)
_Figure 4. The coarse-grained structure of T4 lysozyme after a minimization in vacuum._

### Solvating the system
Now it's time to fill the simulation box with water.

```
gmx solvate -cp minimization-vac.gro -cs water.gro -radius 0.21 -o solvated.gro -p system.top
```
![image](https://github.com/user-attachments/assets/86404276-c2c3-4640-9f44-8888426e302e)

_Figure 5. The system after solvation._


### Adding Ions

After the system has been solvated, it's time to add counter neutralizing ions. Since our protein is charged, it's important to add those ions in order to neutralize our protein's charge. Also, in order to get as close as possible to physiological conditions, it's advisable to use a NaCl concentration of 0.15M.

Usually, a mdp file is supposed to have informations regarding the run, but since in this case the mdp file will only be used to generate a tpr file, it's fine to use an empty file. 
```
touch ions.mdp
```
Once we generated the (empty) mdp file, it's time to generate the .tpr file
```
gmx grompp -f ions.mdp -c solvated.gro -p system.top -o ions.tpr
```
Now that we have the ions.tpr file, it's time to add the ions to our system.

```
gmx genion -s ions.tpr -o solvated.gro -p system.top -pname NA -nname CL -neutral -conc 0.15
```
When prompted, you should select Group 13 (W).  You wouldn't want to add ions to your protein structure, would you?

```
Command line:
  gmx genion -s ions.tpr -o solvated.gro -p system.top -pname NA -nname CL -neutral -conc 0.15

Reading file ions.tpr, VERSION 2024.4-plumed_2.9.2 (single precision)
Reading file ions.tpr, VERSION 2024.4-plumed_2.9.2 (single precision)
Will try to add 39 NA ions and 47 CL ions.
Select a continuous group of solvent molecules
Group     0 (         System) has  3340 elements
Group     1 (        Protein) has   381 elements
Group     2 (      Protein-H) has   381 elements
Group     3 (        C-alpha) has     0 elements
Group     4 (       Backbone) has     0 elements
Group     5 (      MainChain) has     0 elements
Group     6 (   MainChain+Cb) has     0 elements
Group     7 (    MainChain+H) has     0 elements
Group     8 (      SideChain) has   381 elements
Group     9 (    SideChain-H) has   381 elements
Group    10 (    Prot-Masses) has   381 elements
Group    11 (    non-Protein) has  2959 elements
Group    12 (          Other) has  2959 elements
Group    13 (              W) has  2959 elements
Select a group:
Selected 13: 'W'
```
![image](https://github.com/user-attachments/assets/e56b5bfd-2f12-4bfe-ad29-0352a624fb59)
_Figure 6. The system after solvation and the addition of ions._


#### Adding the ligand to the simulation cell

After the system has been solvated, it's time to add the ligand into the simulation cell. In order to do so, first we should make a copy of our .gro file
```
cp solvated.gro protein_ligand.gro
```
Once that's done, it's time to open it in a text editor. Copy the coordinates of your ligand (you will find them inside the ligand .gro file)

```
One benzene molecule
   3
 1BENZ      R1     1   3.092   0.660   2.416
 1BENZ      R2     2   2.882   0.500   2.361
 1BENZ      R3     3   2.986   0.658   2.168
   4.04705   4.04705   4.04705
```
Now add the coordinates at the end of the file, just before the cell lenght
```
 3114CL      CL 3333   5.060   0.707   3.866
 3115CL      CL 3334   4.857   6.938   0.205
 3116CL      CL 3335   6.335   5.101   0.232
 3117CL      CL 3336   6.550   4.857   3.118
 3118CL      CL 3337   7.006   6.194   3.369
 3119CL      CL 3338   6.062   5.445   2.350
 3120CL      CL 3339   5.692   6.195   3.504
 3121CL      CL 3340   7.216   5.363   6.495
 1BENZ       R1    1   3.092   0.660   2.416 
 1BENZ       R2    2   2.882   0.500   2.361 
 1BENZ       R3    3   2.986   0.658   2.168 
   7.53042   7.53042   7.53042
```
![image](https://github.com/user-attachments/assets/ecd27d71-7e68-4416-ae54-885b3d9a0abd)
_Figure 7. Protein and ligand inside the solvated simulation cell._


Don't forget to update the number of atoms in your file! The number of atoms can be found in the second line of your protein_ligand.gro file. 
```
Title of the system in water
 3343 (This number here is the sum of the atoms present in the solvation structure and also the ligand's atoms)
    1MET     BB    1   4.542   2.402   3.751
    1MET    SC1    2   4.688   2.692   3.528
    2ASN     BB    3   4.302   2.597   3.918
    2ASN    SC1    4   4.422   2.533   4.232
    3ILE     BB    5   4.165   2.886   3.999
    3ILE    SC1    6   3.838   2.878   4.098
```
#### Updating the topology file
You should also update your system.top file to reflect the changes done in your gro file. Your final top file should look like this: 
```
#include "martini.itp"
#include "molecule_0.itp"
#include "martini_v3.0.0_small_molecules_v1.itp"
#include "martini_v3.0.0_ions_v1.itp"
#include "martini_v3.0.0_solvents_v1.itp"
#include "nucleotides.itp"

[ system ]
Title of the system in water

[ molecules ]
molecule_0    1
W           2787
NA               39
CL               47
BENZ              1
```

### Second energy minimization

After adding ions and solvating our system, it's important to run a second minimization run. This second minimization run should also be longer than our first one, owing up to the fact that we now have a more complex system that will require more steps before reaching the lowest energy setting.

```
gmx grompp -p system.top -c solvated.gro -f minimization.mdp -o minimization.tpr -r solvated.gro
```
```
gmx mdrun -deffnm minimization -v
```

### Equilibration run -Temperature
This first equilibration run is going to be a so called NVT ensemble or a canonical ensemble. In this type of ensemble, the amount of substance/number of particles (N), volume(V) and temperature are conserved.This step is crucial to get our system to the temperature in which we want to run our simulation. Usually, the thermostat is set to 300K. Although less common, it can be set to 298K in some cases.

```
gmx grompp -p system.top -c minimization.gro -f nvt_eq.mdp -o nvt.tpr -r solvated.gro
```
```
gmx mdrun -deffnm nvt -v
```

### Equilibration run- Pressure
Once the temperature of the system is stabilized, it's time to move on to stabilization of the pressure and density of our system. This step is conducted under an NPT ensemble, which means that the substance/number of particles (N), pressure (P) and temperature (P) are conserved. This ensemble can also be called isothermal-isobaric ensemble. It closelt resembles experimental conditions.

```
gmx grompp -f npt_eq.mdp -c nvt.gro -r nvt.gro -p system.top -o npt.tpr
```
```
gmx mdrun -deffnm npt -v
```
### Production run
After our two rounds of equilibration, our system is now well equilibrated and ready to enter the production run. It is recommend to run this step using sbatch, as it takes considerably longer than the previous steps.

```
gmx grompp -p system.top -c npt.gro -f dynamic.mdp -o dynamic.tpr -maxwarn 1
```
```
gmx mdrun -deffnm dynamic -v -ntmpi 4 -ntomp 6 -pin on
```
By the end of this run, you should have three different files: Two trajectory files (.xtc and .tpr) and a file containing the spatial coordinates of your atoms during your molecular dynamics simulation (.gro)

### Analysis
Now that we have the data generated during our production run, it's time to analyse it. First, we should post-process our trajectory output using gmx trjconv.

This first step removes the jumps that might be caused by periodic boundaries artifacts. When prompted, you should select System (Group 0) as your input.

```
gmx trjconv -s dynamic.tpr -f dynamic.xtc -o traj_nojump.xtc -pbc nojump
```
The second step is here to correct any molecule that may have been "broken" across Periodic Boundary Conditions (PBC). When prompted, you should select System (Group 0)

```
gmx trjconv -s dynamic.tpr -f traj_nojump.xtc -o traj_whole.xtc -pbc whole
```
And finally, the third step makes sure that your protein is centered inside of your simulation box. When prompted, you should select first Protein (Group 1) and then System (Group 0)
```
gmx trjconv -s dynamic.tpr -f traj_whole.xtc -o traj_centered.xtc -center -pbc mol -ur compact
```

### Preparing the system for visualization
Martini3 uses different naming conventions than VMD or Pymol, making these two visualizers unable to properly showcase your protein. Because of the incompatibilities between naming conventions, your system will show up as if just made of solvent and ions.

In order to fix this, first you must generate a pdb file based on your production run.

```
gmx trjconv -f dynamic.xtc -s dynamic.tpr -fit rot+trans -o simulation.pdb -conect
```

Then you should run the renaming.py script to translate the pdb file into a compatible Pymol pdb.

```
python rename.py simulation.pdb simulation_system.pdb
```
Now Pymol should be able to easily read your file.

### Visualization
Open your file in PyMOL. Load your trajectory using the following command: 
```
load_traj traj_centered.xtc, simulation_system, start=0, stop=1000
```
![image](https://github.com/user-attachments/assets/0cd05d6b-88ad-4b1c-8e7a-980cdb1daa00)
_Figure . And there you have it!_

