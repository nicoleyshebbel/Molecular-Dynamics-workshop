# Molecular Dynamics workshop

## What are Molecular Dynamics (MD) simulations? 

Molecular dynamics (MD) simulations are capable of predicting how every atom in a protein or a system will move over time. Such simulations can showcase a variety of biomolecular processes, such as conformational changes, ligand biding and protein folding. 

MD simulations can be divided into two major groups: All-atoms and coarse-grained.

All-atoms simulations represent every atom of the simulation, making them extremely precise if computational heavy. Coarse-grained simulations group atoms into beads, which makes them faster and less computationally heavy at the cost of a slight loss in precision.

## Tools
In this workshop, we will be working with a couple of different tools.

- For coarse-graining our structure and topology, we will be using [Martini3](https://cgmartini.nl/)

- For subsequent stages of the MD simulation, we will be using [GROMACS](https://www.gromacs.org/)
  
- For visualization, we will be using [Pymol](https://pymol.org/)

## GROMACS terminology

- `.top`: This is your topology file. It contains important information about all the atoms present in the structure and how they bond to each other through chemical bonds.

- `.gro`: This is a file where the spatial coordinates of your atoms will be stored during your molecular dynamics simulation. It is a unique file for GROMACS. It can be read on your favourite visualization tool, such as Pymol or VMD, in the same way as a PDB file.

- `-v`: The verbose flag is used to give some feedback on your run. It is good to diagnose errors that might happen in your run.

- `-p`: This flag will tell martinize2 where to put your restraints. In the case of molecular dynamics containing proteins, unless you have a very specific objective, you should put the restraints onto the backbone of your protein.
- `.xtc`: This is your trajectory file. It’s where all the trajectory information from your molecular dynamics will be stored.

- `.tpr`: This file contains both your topology and your coordinates information.

- `.itp`: It stands for Include Topology. This file contains the topology information, which can be bond lengths, bond angles, dihedral angles and force constants, for a specific molecule or group of molecules. Your protein will have its own itp file. This file should be include in the main topology file (e.g your system.top file) using #include. Martini also provides you with some pre-made itp files, such as one for small molecules, solvents and ions. If you wish, or if there’s ever the need for, you could create your own itp files too.

- `.mdp`: This is the file that will set up the parameters for each step of your molecular dynamics run. Each step should have a different mdp file as each step has different parameters; some may need positional restraints while others may have their results affected by that.

- `-ss`: Coarse grained structures such as the ones generated by Martini are known for the loss of directional H bonds. This is an inherent consequence of coarse graining. The loss of those directional H bonds mean that a coarse-grained structure is more likely than all atoms to have its tertiary structures destabilized. One way to mitigate this is to insert a structure bias model. In the case of our simulations, we are using a elastic network structure bias model.

- `-cp`: The configuration of the protein. This is the output of previous gmx editconf steps.

- `-cs`: The configuration of the solvent. This is part of the standard GROMACS installation.

# General Workflow

### Obtaining the input for the simulation
You can manually download your protein(s) of interest directly from your favourite database, e.g The Protein Data Bank. You could also use a command to download it directly into your directory.
```
wget http://www.rcsb.org/pdb/files/your_protein.pdb
```
### Cleaning the input structure
```
grep "^ATOM" your_protein.pdb > your_protein_clean.pdb
```
This step is done in order to avoid that your protein file contains anything but your actual protein. Be careful, this step will remove anything that is not part of your protein including ligands. After you clean your structure, open the your_protein_clean.pdb file in your favourite visualizer to make sure it contains only the protein.

### Generating topology and coarse-grained structure
```
martinize2 -f your_protein_clean.pdb -o system.top -x cg_protein.pdb -p backbone -ff martini3001 -elastic -ef 700.0 -el 0.5 -eu 0.9 -ea 0 -ep 0 -ss input your secondary structure in here
```
martinize2 will generate 3 different files: A coarse-grained structure (cg_protein.pdb), a topology file ( system.top) and protein topology file ( molecule_0.itp). The amount of protein topology files will be entirely depedent on the amount of proteins in your system. Now, we should make a box that will accomodate our protein.

The CGMD method, where the atomic degrees of freedom of all atoms are sacrificed by coarse-graining them into a small number of simulation particles, reduces computational costs and allows for a larger time and length scale of simulation [10].


### Defining the simulation box
```
gmx editconf -f cg_protein.pdb -o cg_protein.gro -d 1.0 -bt cubic -c
```
You want to make sure that your protein has enough room inside the box to avoid close contacts between periodic images of the protein. Typically, a minimum distance of 1.0 nm from the protein to any box edge tends to be used. If you still encounter close contacts, it might be recommend to make your box larger (e.g allowing for a distance of 1.5 nm from the protein to any box edge)

#### Checking the topology

You will need to add some more lines into your system.top file. The order of these files is extremely important, so you should be mindful where you put them. It is important that martini.itp, the file that gives the parameters for the Martini force field, be the first file. After that, it should come your molecule(s) topology file. And after the topology, then you can add other files. TBy now, your topology file for your system should look something like this:
```
#include "martini.itp"
#include "molecule_0.itp"
#include "martini_v3.0.0_small_molecules_v1.itp"
#include "martini_v3.0.0_ions_v1.itp"
#include "martini_v3.0.0_solvents_v1.itp"
#include "nucleotides.itp"

[ system ]
Title of the system in water

[ molecules ]
molecule_0    1
```

### Energy minimization
 
Once the protein has been placed inside the simulation box, it's time to run a short minimization run. This step ensures that there are no steric clashes or inappropriate geometry in our system.  

gmx grompp will assemble the structure, topology and simulation parameters into a binary input file (.tpr). This file file will be used in a later step to run the energy minimization.

```
gmx grompp -p system.top -f minimization.mdp -c system.gro -o minimization-vac.tpr  -r your_protein_cg.gro
```
Now that we have our .tpr file, we can run the energy minimization
```
gmx mdrun -deffnm minimization-vac -v
```
### Solvating the system
Now it's time to fill the simulation box with water.

```
gmx solvate -cp minimization-vac.gro -cs water.gro -radius 0.21 -o solvated.gro -p system.top
```

### Adding Ions

After the system has been solvated, it's time to add counter neutralizing ions. Since our protein is charged, it's important to add those ions in order to neutralize our protein's charge. Also, in order to get as close as possible to physiological conditions, it's advisable to use a NaCl concentration of 0.15M.

Usually, a mdp file is supposed to have informations regarding the run, but since in this case the mdp file will only be used to generate a tpr file, it's fine to use an empty file. 
```
touch ions.mdp
```
Once we generated the (empty) mdp file, it's time to generate the .tpr file
```
gmx grompp -f ions.mdp -c solvated.gro -p system.top -o ions.tpr
```
Now that we have the ions.tpr file, it's time to add the ions to our system.

```
gmx genion -s ions.tpr -o solvated.gro -p system.top -pname NA -nname CL -neutral -conc 0.15
```

### Second energy minimization

After adding ions and solvating our system, it's important to run a second minimization run. This second minimization run should also be longer than our first one, owing up to the fact that we now have a more complex system that will require more steps before reaching the lowest energy setting.

```
gmx grompp -p system.top -c solvated.gro -f minimization.mdp -o minimization.tpr -r solvated.gro
```
```
gmx mdrun -deffnm minimization -v
```

### Equilibration run -Temperature
This first equilibration run is going to be a so called NVT ensemble or a canonical ensemble. In this type of ensemble, the amount of substance/number of particles (N), volume(V) and temperature are conserved. In the canonical ensemble, amount of substance (N), volume (V) and temperature (T) are conserved. This step is crucial to get our system to the temperature in which we want to run our simulation. Usually, the thermostat is set to 300K. Though less common, it can be set to 298K in some cases.

```
gmx grompp -p system.top -c minimization.gro -f nvt_eq.mdp -o nvt.tpr -r solvated.gro
```
```
gmx mdrun -deffnm nvt -v
```

### Equilibration run- Pressure
Once the temperature of the system is stabilized, it's time to move on to stabilization of the pressure and density of our system. This step is conducted under an NPT ensemble, which means that the substance/number of particles (N), pressure (P) and temperature (P) are conserved. This ensemble can also be called isothermal-isobaric ensemble. It closelt resembles experimental conditions.

```
gmx grompp -f npt_eq.mdp -c nvt.gro -r nvt.gro -p system.top -o npt.tpr
```
```
gmx mdrun -deffnm npt -v
```
### Production run
After our two rounds of equilibration, our system is now well equilibrated and ready to enter the production run. It is recommend to run this step using sbatch, as it takes considerably longer than the previous steps.

```
gmx grompp -p system.top -c npt.gro -f dynamic.mdp -o dynamic.tpr -maxwarn 1
```
```
gmx mdrun -deffnm dynamic -v
```
By the end of this run, you should have three different files: Two trajectory files (.xtc and .tpr) and a file containing the spatial coordinates of your atoms during your molecular dynamics simulation (.gro)

### Analysis
Now that we have the data generated during our production run, it's time to analyse it. First, we should post-process our trajectory output using gmx trjconv.

This first step removes the jumps that might be caused by periodic boundaries artifacts. When prompted, you should select System (Group 0) as your input.

```
gmx trjconv -s dynamic.tpr -f dynamic.xtc -o traj_nojump.xtc -pbc nojump
```
The second step is here to correct any molecule that may have been "broken" across Periodic Boundary Conditions (PBC). When prompted, you should select System (Group 0)

```
gmx trjconv -s dynamic.tpr -f traj_nojump.xtc -o traj_whole.xtc -pbc whole
```
And finally, the third step makes sure that your protein is centered inside of your simulation box. When prompted, you should select first Protein (Group 1) and then System (Group 0)
```
gmx trjconv -s dynamic.tpr -f traj_whole.xtc -o traj_centered.xtc -center -pbc mol -ur compact
```

### Preparing the system for visualization
Martini3 uses different naming conventions than VMD or Pymol, making these two visualizers unable to properly showcase your protein. Because of the incompatibilities between naming systems, your system will show up as if just made of solvent and ions.

In order to fix this, first you must generate a pdb file based on your production run.

```
gmx trjconv -f dynamic.xtc -s dynamic.tpr -fit rot+trans -o simulation.pdb -conect
```

Then you should run the renaming.py script to translate the pdb file into a compatible Pymol pdb.

```
python rename.py input.pdb output.pdb
```
Now Pymol should be able to easily read your file.
